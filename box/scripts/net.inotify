#!/system/bin/sh

events=$1
# monitor_dir=$2
# monitor_file=$3

scripts=$(realpath $0)
scripts_dir=$(dirname ${scripts})

source ${scripts_dir}/box.config

export TZ=Asia/Shanghai

rules_add() {
  ip -4 a | awk '/inet/ {print $2}' | grep -vE "^127.0.0.1" | while read -r local_ipv4 ; do
    iptables -w 100 -t mangle -A BYPASS_IP -d $local_ipv4 -p udp ! --dport 53 -j ACCEPT
	iptables -w 100 -t mangle -A BYPASS_IP -d $local_ipv4 ! -p udp -j ACCEPT
    rv1=$?
    iptables -w 100 -t nat -A BYPASS_IP -d $local_ipv4 -p udp ! --dport 53 -j ACCEPT
	iptables -w 100 -t nat -A BYPASS_IP -d $local_ipv4 ! -p udp -j ACCEPT
    rv2=$?
    ( [ $rv1 = "0" ] || [ $rv2 = "0" ] ) && echo "$(date +"[%Y-%m-%d %H:%M:%S %Z]") [Info]: local ip is $local_ipv4, anti-loopback rule has been inserted" >> ${run_path}/run.log 2>> ${run_path}/run_error.log
  done

  ip -6 a | awk '/inet6/ {print $2}' | grep -vE "^fe80|^::1" | while read -r local_ipv6 ; do
	ip6tables -w 100 -t mangle -A BYPASS_IP6 -d $local_ipv6 -p udp ! --dport 53 -j ACCEPT
	ip6tables -w 100 -t mangle -A BYPASS_IP6 -d $local_ipv6 ! -p udp -j ACCEPT
    rv1=$?
    ip6tables -w 100 -t nat -A BYPASS_IP6 -d $local_ipv6 -p udp ! --dport 53 -j ACCEPT
	ip6tables -w 100 -t nat -A BYPASS_IP6 -d $local_ipv6 ! -p udp -j ACCEPT
    rv2=$?
    ( [ $rv1 = "0" ] || [ $rv2 = "0" ] ) && echo "$(date +"[%Y-%m-%d %H:%M:%S %Z]") [Info]: local ip is $local_ipv6, anti-loopback rule has been inserted" >> ${run_path}/run.log 2>> ${run_path}/run_error.log
  done
}

mkdir -p ${run_path}

if [ $events = "w" ] ; then
  rules_add
fi
